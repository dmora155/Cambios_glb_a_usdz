<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversi√≥n de GLB a USDZ</title>

    <!-- Cargar Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <!-- Cargar dependencias necesarias -->
    <script src="https://cdn.jsdelivr.net/npm/fflate@0.8.0/umd/index.js"></script>

    <!-- Cargar GLTFLoader, USDZExporter y GLTFExporter -->
    <script src="https://cdn.jsdelivr.net/npm/three/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three/examples/js/exporters/USDZExporter.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three/examples/js/exporters/GLTFExporter.js"></script>

    <script>
        function convertAndDownload() {
            const fileInput = document.getElementById('glb-file');
            const file = fileInput.files[0];

            if (!file) {
                alert("Por favor, selecciona un archivo GLB.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const loader = new THREE.GLTFLoader();
                loader.parse(event.target.result, '', function(gltf) {
                    const scene = gltf.scene;
                    scaleModel(scene);

                    exportGLB(scene); // Descargar GLB con escala reducida
                    exportUSDZ(scene); // Descargar USDZ
                }, function(error) {
                    console.error("Error al cargar GLB:", error);
                });
            };

            reader.readAsArrayBuffer(file);
        }

        function scaleModel(model) {
            console.log("üìè Reducci√≥n de escala iniciada...");
            model.scale.multiplyScalar(0.01); // Reduce la escala 100 veces (de cm a metros)
            model.updateMatrixWorld(true);
            console.log("‚úÖ Modelo escalado correctamente.");
        }

        function exportUSDZ(model) {
            const exporter = new THREE.USDZExporter();
            exporter.parse(model).then(function (arraybuffer) {
                const blob = new Blob([arraybuffer], { type: "model/vnd.usdz+zip" });
                const url = URL.createObjectURL(blob);

                const downloadLink = document.createElement("a");
                downloadLink.href = url;
                downloadLink.download = "modelo_convertido.usdz";
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);

                alert("‚úÖ Modelo USDZ exportado y descargado correctamente.");
            }).catch(function (error) {
                console.error("Error al exportar a USDZ:", error);
            });
        }

        function exportGLB(model) {
            const exporter = new THREE.GLTFExporter();

            exporter.parse(model, function (gltf) {
                const glbBlob = new Blob([gltf], { type: "model/gltf-binary" });
                const glbUrl = URL.createObjectURL(glbBlob);

                const glbDownloadLink = document.createElement("a");
                glbDownloadLink.href = glbUrl;
                glbDownloadLink.download = "modelo_convertido.glb";
                document.body.appendChild(glbDownloadLink);
                glbDownloadLink.click();
                document.body.removeChild(glbDownloadLink);

                alert("‚úÖ Modelo GLB exportado y descargado correctamente con la escala reducida.");
            }, { binary: true });
        }
    </script>
</head>
<body>
    <h1>Conversi√≥n de GLB a USDZ</h1>
    <p>Selecciona un archivo GLB y haz clic en el bot√≥n para convertirlo a USDZ y GLB con escala reducida.</p>

    <div>
        <input type="file" id="glb-file" accept=".glb">
        <button onclick="convertAndDownload()">Convertir y Descargar</button>
    </div>
</body>
</html>
